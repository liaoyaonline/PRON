# 随机森林的推荐模型构建分析
## 数据集获取
现阶段我国已经有多个在线阅读平台，其中优书网可以给用户提供评分，评论，添加标签等服务，此外优书网对于用户的小说评分进行了记录，本文收集了优书网中的部分数据，选择书架书本五十以上的用户进行研究，抽取的小说数量和书单数量分别为42,883和18,943获取的用户信息为，完成上述工作后，本文对抽取到的小说信息进行了算法的研究。
目前我国有多个在线阅读平台，其中优书网是国内最大的小说评论网站，本文对优书网中的部分小说信息进行收集，总计收集的小说数量42,883，收集的书单数量为18,943。小说的特征大致可以分类为以下两种：
固有特征：小说本身一些特征，比如小说字数，小说名，最近更新时间，作者名，更新状态等。
联动特征：由于他人评论添加而改动的特征，比如小说评分，评分人数，各评分星级占比率，收录书单数等。
本文对上述特征进行粗略的加工，去掉一些明显不能对小说分类产生影响的特征，比如小说名，作者名等特征。
本文选取书架书本在100本以上的读者的做为数据集进行算法的研究，去除部分不合规格的小说，譬如章节总数小于20章，评分人数低于10人的小说。
小说数据库截图：
书单数据库截图：
书架数据库截图：
## CART子树结构构建分析
本次随机森林算法选择的基分类器是CART分类决策树，CART决策树是二叉树，相对与ID3决策树和C4.5决策树相比，不容易产生数据碎片，其精度往往高于多叉树。以下表格所展示的小说数据集为例，构建一颗简单的CART分类决策树。
数据表
Species
setosa-----setosa-----setosa-----versicolor-----versicolor-----versicolor-----versicolor-----virginica-----virginica-----virginica-----virginica-----
Sepal.Width
3.5-----3.2-----3.1-----3.2-----3.1-----2.3-----2.8-----3.3-----2.7-----3.4-----3-----
Sepal.Length
5.1-----4.7-----4.6-----7-----6.9-----5.5-----5.7-----6.3-----5.8-----6.2-----5.9-----
Petal.Width
0.2-----0.2-----0.2-----1.4-----1.5-----1.3-----1.3-----2.5-----1.9-----2.3-----1.8-----
Petal.Length
1.4-----1.3-----1.5-----4.7-----4.9-----4-----4.1-----6-----5.1-----5.4-----5.1----


Sepal.Length Sepal.Width Petal.Length Petal.Width Species
13
5.1 3.5 1.4 1.5 setosa
4.9 3 1.4 0.2 setosa
4.7 3.2 1.3 1.4 setosa
4.6 3.1 1.5 2.5 setosa
5 3.3 1.4 1.3 setosa
7 3.2 4.7 1.3 versicolor
6.9 3.1 4.9 0.2 versicolor
5.5 2.3 4 1.5 versicolor
6.3 3.3 6 0.2 virginica
5.8 2.7 5.1 1.9 virginica
7.1 3 5.9 2.3 virginica
6.2 3.4 5.4 0.2 virginica
5.9 3 5.1 1.8 virginica

\begin{table}[H]
	\caption{特征Gini Importance}
	\label{tab:Feature1}
	\centering
	\begin{tabular}{l l l l l}
		\toprule
		{Sepal.Length } & {Sepal.Length } & {Sepal.Length } & {Sepal.Length }& {Sepal.Length }\\
		\midrule
		5.1 & 3.5 & 1.4 & 1.5&setosa\\
		4.9 &  3 &  1.4  & 0.2 &setosa\\
		4.7  & 3.2 & 1.3 & 1.4&setosa\\
		4.6  & 3.1 & 1.5 & 2.5&setosa\\
		5  & 3.3 & 1.4 & 1.3&setosa\\
		7  & 3.2 & 4.7 & 1.3&versicolor\\
		6.9  & 3.1 & 4.9 & 0.2&versicolor\\
		5.5 & 2.3 & 4 & 1.5&versicolor\\
		6.3 & 3.3 & 6 & 0.2&virginica\\
		5.8  & 2.7 & 5.1 & 1.9&virginica\\
		7.1  & 3 & 5.9& 2.3&virginica\\
		6.2  & 3.4 & 5.4& 0.2&virginica\\
		5.9  & 3 & 5.1 & 1.8&virginica\\
		\bottomrule\\
	\end{tabular}
\end{table}

\begin{table}[H]
	\caption{特征Gini Importance}
	\label{tab:Feature1}
	\centering
	\begin{tabular}{l l l l l}
		\toprule
		{A } & {B } & {C } & {D }& {Result }\\
		\midrule
		5.1 & 3.5 & 1.4 & 1.5&R1\\
		4.9 &  3 &  1.4  & 0.2 &R1\\
		4.7  & 3.2 & 1.3 & 1.4&R1\\
		4.6  & 3.1 & 1.5 & 2.5&R1\\
		5  & 3.3 & 1.4 & 1.3&R1\\
		7  & 3.2 & 4.7 & 1.3&R2\\
		6.9  & 3.1 & 4.9 & 0.2&R2\\
		5.5 & 2.3 & 4 & 1.5&R2\\
		6.3 & 3.3 & 6 & 0.2&R3\\
		5.8  & 2.7 & 5.1 & 1.9&R3\\
		7.1  & 3 & 5.9& 2.3&R3\\
		6.2  & 3.4 & 5.4& 0.2&R3\\
		5.9  & 3 & 5.1 & 1.8&R3\\
		\bottomrule\\
	\end{tabular}
\end{table}
首先需要构建CART分类决策树的结构体，该结构体需要记录当前节点的数据集D,当前节点的特征集A，以及子树节点地址等信息。所以该结构体的定义如下：
结构体（简化)
class Tree_Node
{
public:
    Tree_Node();
	Tree_Node(map<string, vector<string>> temp_Table, vector<string> temp_Attribute);
	//生成子节点
	void generate_ChildNode();
	//计算基尼指数 寻找最优划分属性
	string findBestAttribute(); //寻找最佳划分节点
private:
    string Attribute_CurrentNode;//当前节点属性
    double GiniValue_CurrentNode;//当前节点Gini值
    double NumSample_CurrentNode;//当前节点样本数目
    int NumAtt_CurrentNode;//当前节点属性数目
    map<string, Tree_Node *> childNode;//子节点
};
结构体中的当前特征就是一次次分类的标杆，根据测试数据中特征的属性不同，而进入不同的子节点，最后显示预测结果，接下来详细介绍CART分类决策书的构造过程。
１）扫描数据集D和特征集A，计算数据集中所有特征的基尼指数，根据基尼指数从小到达排列，如下表所示：
基尼指数表：

Sepal.Lengthsign_divide : 4.65Gini_tmp:  0.602564
Sepal.Lengthsign_divide : 4.8Gini_tmp:  0.545455
Sepal.Lengthsign_divide : 4.95Gini_tmp:  0.476923
Sepal.Lengthsign_divide : 5.05Gini_tmp:  0.393162
Sepal.Lengthsign_divide : 5.3Gini_tmp:  **0.288462**


Sepal.Widthsign_divide : 2.5Gini_tmp:  **0.576923**


Petal.Lengthsign_divide : 1.45Gini_tmp:  0.393162
Petal.Lengthsign_divide : 2.75Gini_tmp: **0.288462**
Petal.Lengthsign_divide : 4.35Gini_tmp:  0.347985
Petal.Lengthsign_divide : 5Gini_tmp:  0.288462



Petal.Widthsign_divide : 1.65Gini_tmp:  **0.559829**



\begin{table}[H]
	\caption{各特征基尼指数}
	\label{tab:FeatureGiniIndex}
	\centering
	\begin{tabular}{l l l}
		\toprule
		{特征名} & {最佳划分点t} & {基尼指数} \\
		\midrule
		Sepal.Length & 5.3 & 0.288462\\
		Sepal.Width & 2.5 & 0.576923\\
		Petal.Length & 2.75 & 0.288462\\
		Petal.Width & 1.65 & 0.559829\\
		\bottomrule\\
	\end{tabular}
\end{table}











Sepal.Length 
Sepal.Lengthsign_divide : 4.9Gini_tmp:  0.484848
Sepal.Lengthsign_divide : 4.9Gini_tmp:  0.484848
Sepal.Lengthsign_divide : 5.3Gini_tmp:  **0.363636**
Sepal.Lengthsign_divide : 5.6Gini_tmp:  0.448052
Sepal.Lengthsign_divide : 5.75Gini_tmp:  0.460606n
：Sepal.Lengthsign_divide : 5.85Gini_tmp:  0.551515
Sepal.Lengthsign_divide : 6.05Gini_tmp:  0.597403
Sepal.Lengthsign_divide : 6.25Gini_tmp:  0.598485
Sepal.Lengthsign_divide : 6.6Gini_tmp:  0.525253
Sepal.Lengthsign_divide : 6.95Gini_tmp:  0.6




Sepal.Width 
Sepal.Widthsign_divide : 2.5Gini_tmp:  0.6
Sepal.Widthsign_divide : 2.75Gini_tmp:  0.636364
Sepal.Widthsign_divide : 2.9Gini_tmp:  0.598485
Sepal.Widthsign_divide : 3.05Gini_tmp:  0.597403
Sepal.Widthsign_divide : 3.15Gini_tmp:  0.624242
Sepal.Widthsign_divide : 3.25Gini_tmp:  **0.575758**
Sepal.Widthsign_divide : 3.35Gini_tmp:  0.616162
Sepal.Widthsign_divide : 3.45Gini_tmp:  0.581818


Petal.Lengthsign_divide : 1.35Gini_tmp:  0.581818
Petal.Lengthsign_divide : 1.45Gini_tmp:  0.484848
Petal.Lengthsign_divide : 2.75Gini_tmp:  0.363636
Petal.Lengthsign_divide : 4.05Gini_tmp:  0.448052
Petal.Lengthsign_divide : 4.4Gini_tmp:  0.460606
Petal.Lengthsign_divide : 4.8Gini_tmp:  0.418182
Petal.Lengthsign_divide : 5Gini_tmp:  **0.311688**
Petal.Lengthsign_divide : 5.25Gini_tmp:  0.525253
Petal.Lengthsign_divide : 5.7Gini_tmp:  0.6



Petal.Widthsign_divide : 0.75Gini_tmp:  0.363636
Petal.Widthsign_divide : 1.35Gini_tmp:  0.460606
Petal.Widthsign_divide : 1.45Gini_tmp:  0.418182
Petal.Widthsign_divide : 1.65Gini_tmp:  **0.311688**
Petal.Widthsign_divide : 1.85Gini_tmp:  0.431818
Petal.Widthsign_divide : 2.1Gini_tmp:  0.525253
Petal.Widthsign_divide : 2.4Gini_tmp:  0.6









Petal.Length Petal.Width Species

从上表可以看出，选择A特征划分后的基尼指数最小，所以选择A特征做为根节点的当前特征。其可视化树结构如下图所示：
其中xx是xx,xx是xx
其每个子树的数据集如下表所示：
两个子树数据集：

2)对每个子树都重复步骤一，直至决策树构造到叶节点，构造截止。最后生成的CART分类决策树如下图所示：